name: Lighthouse Audit for Static Site

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install static server
        run: npm install -g serve

      - name: Serve PR branch (background on port 3001)
        run: |
          serve . -l 3001 &
          sleep 5

      - name: Run Lighthouse for PR branch
        id: lighthouse_pr
        uses: foo-software/lighthouse-check-action@master
        with:
          gitHubAccessToken: ${{ secrets.GITHUB_TOKEN }}
          prCommentEnabled: true
          prCommentSaveOld: false
          urls: http://localhost:3001

      - name: Checkout main branch into separate folder
        run: |
          git fetch origin main
          git worktree add main-branch origin/main

      - name: Serve Main branch (background on port 3000)
        run: |
          cd main-branch
          serve . -l 3000 &
          cd ..
          sleep 5

      - name: Run Lighthouse for Main branch
        id: lighthouse_main
        uses: foo-software/lighthouse-check-action@master
        with:
          gitHubAccessToken: ${{ secrets.GITHUB_TOKEN }}
          prCommentEnabled: false  # We'll manually combine comments
          urls: http://localhost:3000

      - name: Post combined PR comment
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            PR_RESULTS='${{ steps.lighthouse_pr.outputs.lighthouseCheckResults }}'
            MAIN_RESULTS='${{ steps.lighthouse_main.outputs.lighthouseCheckResults }}'
        
            COMMENT="### Lighthouse Audit Results
        
        ðŸŸ¢ **Main Branch** (port 3000): http://localhost:3000  
        ðŸ”µ **PR Branch** (port 3001): http://localhost:3001
        
         <details><summary>View Scores</summary>
         
         **Main Branch:**  
         \`\`\`json
         $MAIN_RESULTS
         \`\`\`
         
         **PR Branch:**  
         \`\`\`json
         $PR_RESULTS
         \`\`\`
        
         </details>"
        
            echo "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body -
        